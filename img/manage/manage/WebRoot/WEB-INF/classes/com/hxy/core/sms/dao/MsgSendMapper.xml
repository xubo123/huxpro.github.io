<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hxy.core.sms.dao.MsgSendMapper">
	<resultMap type="com.hxy.core.sms.entity.MsgSend" id="msgSendResultMap">
		<id column="msg_id" property="msgId" />
		<result column="dept_id" property="deptId" />
		<result column="staff_id" property="staffId" />
		<result column="telphone" property="telphone" />
		<result column="content" property="content" />
		<result column="statues" property="statues" />
		<result column="sendtime" property="sendtime" />
		<result column="msg_type" property="msgType" />
		<result column="countNumber" property="countNumber" />
		<result column="messagegroup" property="messagegroup" />
		<result column="receivetime" property="receivetime" />
		<result column="errorcode" property="errorCode" />
		<result column="userAccount" property="userAccount"/>
	</resultMap>
	<insert id="insertMsg" parameterType="com.hxy.core.sms.entity.MsgSend">
		insert into
		msg_send(dept_id,staff_id,telphone,content,statues,sendtime,msg_type,countNumber,messagegroup,receivetime,errorcode)
		values(#{deptId},#{staffId},#{telphone},#{content},#{statues},#{sendtime},#{msgType},#{countNumber},#{messagegroup},#{receivetime},#{errorCode});
	</insert>
	<!-- 根据键值获取短息配置信息 -->
	<select id="getSMSConfig" resultType="map" parameterType="String">
		SELECT * FROM sms_config WHERE config_key = #{config_key} ORDER BY id DESC LIMIT 1
	</select>
	<update id="updateByPM" parameterType="com.hxy.core.sms.entity.MsgSend">
		update msg_send
		<set>
			<if test="deptId!=null and deptId!=''">
				dept_id=#{deptId},
			</if>
			<if test="staffId!=null and staffId!=0">
				staff_id=#{staffId},
			</if>
			<if test="content!=null and content!=''">
				content=#{content},
			</if>
			<if test="statues!=null">
				statues=#{statues},
			</if>
			<if test="sendtime!=null">
				sendtime=#{sendtime},
			</if>
			<if test="msgType!=null and msgType!=0">
				msg_type=#{msgType},
			</if>
			<if test="countNumber!=null and countNumber!=0">
				countNumber=#{countNumber},
			</if>
			<if test="receivetime!=null">
				receivetime=#{receivetime},
			</if>
			<if test="errorCode!=null and errorCode!=''">
				errorcode=#{errorCode}
			</if>
		</set>
		where telphone=#{telphone} and messagegroup=#{messagegroup}
	</update>
	<update id="updateStatusReport" parameterType="com.hxy.core.sms.entity.MsgSend">
		update msg_send set statues=#{statues},receivetime=#{receivetime},errorcode=#{errorCode} 
		where telphone=#{telphone} and messagegroup=#{messagegroup}
	</update>
	<update id="updateStatus" parameterType="com.hxy.core.sms.entity.MsgSend">
		update msg_send set statues=#{statues},messagegroup=#{smsID}
		where msg_id=#{msgId}
	</update>
	<select id="selectTopMsgId" parameterType="int" resultMap="msgSendResultMap">
	select
	msg_id,telphone,content,messagegroup
	from msg_send where statues=9 and msg_id>#{msgId} order by msg_id
	asc limit 0,500
	</select>
	<insert id="insertMsgSend" parameterType="com.hxy.core.sms.entity.MsgSend">
		insert into
		msg_send(dept_id,staff_id,telphone,content,statues,sendtime,msg_type,countNumber,messagegroup,receivetime,errorcode)
		values(#{deptId},#{staffId},#{telphone},#{content},#{statues},#{sendtime},#{msgType},#{countNumber},#{messagegroup},#{receivetime},#{errorCode});
	</insert>
	<select id="countOutBox" parameterType="map" resultType="long">
		SELECT
		count(msg_id) from msg_send
		<where>
			<if test="telphone!=null">
				telphone like concat('%',#{telphone},'%')
			</if>
			<if test="staffId!=null">
				and staff_id=#{staffId}
			</if>
		</where>
	</select>
	<select id="selectOutBox" parameterType="map"
		resultMap="msgSendResultMap">
		select *,u.userAccount from msg_send left join user u on staff_id = u.userId
		<where>
			<if test="telphone!=null">
				telphone like concat('%',#{telphone},'%')
			</if>
			<if test="staffId!=null">
				and staff_id=#{staffId}
			</if>
		</where>
		ORDER BY sendtime DESC limit
		#{start},#{rows}
	</select>
	<select id="selectByMsgGroup" parameterType="string" resultMap="msgSendResultMap"
		useCache="false">
		select telphone,statues,errorcode from msg_send where
		messagegroup = #{messagegroup}
	</select>
	<select id="selectByMGAndTel" parameterType="map" resultMap="msgSendResultMap"
		useCache="false">
		select * from msg_send where messagegroup =
		#{messagegroup} and telphone = #{telphone}
	</select>
	<select id="selectByDate" parameterType="map" resultMap="msgSendResultMap"
		useCache="false">
		select * from msg_send where <![CDATA[sendtime<#{endtime}]]>
	</select>
	<delete id="deleteByDate" parameterType="map">
		delete from msg_send where <![CDATA[sendtime<#{endtime}]]>
	</delete>
</mapper>