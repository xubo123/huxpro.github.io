<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hxy.core.news.dao.NewsMapper">
	<resultMap type="com.hxy.core.news.entity.News" id="newsResultMap">
		<id column="newsId" property="newsId" />
		<result column="title" property="title" />
		<result column="content" property="content" />
		<result column="pic" property="pic" />
		<result column="introduction" property="introduction" />
		<result column="createTime" property="createTime" />
		<result column="type" property="type" />
		<result column="channelName" property="channelName" />
		<result column="newsUrl" property="newsUrl" />
		<result column="fDateTime" property="fDateTime" />
		<result column="cityName" property="cityName" />
		<result column="category" property="category" />
		<result column="categoryName" property="categoryName" />
		<result column="topnews" property="topnews" />
		<result column="pCategory" property="pCategory" />
		<result column="pCategoryName" property="pCategoryName" />
		<result column="origin" property="origin" />
		<result column="originWeb" property="originWeb" />
		<result column="categoryWeb" property="categoryWeb" />
		<result column="categoryWebName" property="categoryWebName" />
		<result column="topnewsWeb" property="topnewsWeb" />
		<result column="pCategoryWeb" property="pCategoryWeb" />
		<result column="pCategoryWebName" property="pCategoryWebName" />
		<result column="dept_id" property="dept_id" />
		<result column="dept_name" property="dept_name" />
	</resultMap>
	<resultMap type="com.hxy.core.news.entity.News2" id="news2ResultMap">
		<id column="id" property="newsId" />
		<result column="news_title" property="title" />
		<result column="news_channel_id" property="category" />
		<result column="news_context" property="content" />
		<result column="news_memo" property="introduction" />
		<result column="news_image" property="pic" />
		<result column="key_word" property="keyWord" />
		<result column="news_type" property="type" />
		<result column="modified_date" property="modifyTime" />
		<result column="created_date" property="createTime" />
		<result column="news_url" property="newsUrl" />
		<result column="created_by" property="creator" />
		<result column="category" property="category" />
		<result column="categoryName" property="categoryName" />
		<result column="tagId" property="tagId" />
		<result column="tagName" property="tagName" />
		<result column="pCategoryName" property="pCategoryName" />
	</resultMap>

	<resultMap type="com.hxy.core.news.entity.News" id="newsNoContentResultMap">
		<id column="newsId" property="newsId" />
		<result column="title" property="title" />
		<result column="pic" property="pic" />
		<result column="introduction" property="introduction" />
		<result column="createTime" property="createTime" />
		<result column="type" property="type" />
		<result column="channelName" property="channelName" />
		<result column="newsUrl" property="newsUrl" />
		<result column="category" property="category" />
		<result column="categoryName" property="categoryName" />
		<result column="topnews" property="topnews" />
		<result column="fDateTime" property="fDateTime" />
		<result column="cityName" property="cityName" />
	</resultMap>

	<resultMap type="com.hxy.core.dict.entity.Dict" id="dictResultMap">
		<id column="dict_id" property="dictId" />
		<result column="dict_type_id" property="dictTypeId" />
		<result column="dict_name" property="dictName" />
		<result column="dict_value" property="dictValue" />
	</resultMap>
	<select id="countNews" parameterType="map" resultType="long">
		select count(newsId) from news cyn
		LEFT OUTER JOIN mobile_news_type
		mtype ON cyn.category = mtype.id
		LEFT OUTER JOIN web_news_type wtype ON
		cyn.categoryWeb = wtype.id
		<where>
			(mtype.type = 1 or wtype.type = 1)
			<if test="deptList!=null and deptList.size()>0">
				and cyn.dept_id in
				<foreach collection="deptList" open="(" close=")" item="dept"
					separator=",">
					#{dept.deptId}
				</foreach>
			</if>
			<if test="title!=null and title!=''">
				and cyn.title like concat('%',#{title},'%')
			</if>
			<if test="channelNameList!=null">
				and channelName in
				<foreach collection="channelNameList" open="(" close=")"
					item="channelName" separator=",">
					#{channelName}
				</foreach>
			</if>
			<if test="cityName!=null and cityName!=''">
				and cyn.cityName like concat('%',#{cityName},'%')
			</if>
		</where>
	</select>
	<select id="countNews2" parameterType="map" resultType="long">
		select
		count(id) from news_data
		<where>
			<if test="title!=null and title!=''">
				and news_title like concat('%',#{title},'%')
			</if>
		</where>
	</select>
	<select id="countNewsForAlumni" parameterType="map" resultType="long">
		select
		count(id) from news_data left join news_tag on
		news_data.news_tag_id = news_tag.tagId
		<where>
			<if test="title!=null and title!=''">
				and news_title like concat('%',#{title},'%')
			</if>
			<if test="deptList!=null and deptList!=''">
				and news_tag.department_id in
				<foreach collection="deptList" open="(" close=")" item="dept"
					separator=",">
					#{dept.department_id}
				</foreach>
			</if>

		</where>
	</select>

	<!-- 管理后台新闻列表数据,不需要查询content -->
	<select id="selectNews" parameterType="map" resultMap="newsResultMap">
		<!-- select newsId, title, content=null, pic, introduction, createTime, 
			cyn.type, channelName, newsUrl, category, cyd.dict_name AS categoryName,topnews,cityName 
			from news cyn LEFT OUTER JOIN dict cyd ON cyn.category = cyd.dict_id where 
			1 = 1 -->
		select newsId, title, content=null, pic, introduction, createTime,
		cyn.type, channelName,newsUrl,cyn.cityName,cyn.dept_id,d.dept_name,
		mtype.origin as origin, pmtype.origin as originP,
		wtype.origin as
		originWeb,pwtype.origin as originWebP,
		category, mtype.name AS
		categoryName,topnews,mtype.parent_id as pCategory,pmtype.`name` as
		pCategoryName,
		categoryWeb, wtype.name AS
		categoryWebName,topnewsWeb,wtype.parent_id as
		pCategoryWeb,pwtype.`name` as pCategoryWebName
		from news cyn
		LEFT OUTER
		JOIN mobile_news_type mtype ON cyn.category = mtype.id
		LEFT OUTER JOIN
		mobile_news_type pmtype ON mtype.parent_id = pmtype.id
		LEFT OUTER JOIN
		web_news_type wtype ON cyn.categoryWeb = wtype.id
		LEFT OUTER JOIN
		web_news_type pwtype ON wtype.parent_id = pwtype.id
		LEFT OUTER JOIN
		cy_dept_info d on cyn.dept_id = d.dept_id
		<where>
			(mtype.type = 1 or wtype.type = 1)
			<if test="deptList!=null and deptList.size()>0">
				and cyn.dept_id in
				<foreach collection="deptList" open="(" close=")" item="dept"
					separator=",">
					#{dept.deptId}
				</foreach>
			</if>
			<if test="title!=null and title!=''">
				and title like concat('%',#{title},'%')
			</if>
			<if test="channelNameList!=null">
				and channelName in
				<foreach collection="channelNameList" open="(" close=")"
					item="channelName" separator=",">
					#{channelName}
				</foreach>
			</if>
			<if test="cityName!=null and cityName!=''">
				and cyn.cityName like concat('%',#{cityName},'%')
			</if>
		</where>
		<if test="start!=null and rows!=null ">
			order by createTime desc limit #{start},#{rows}
		</if>
	</select>
	<!-- 管理后台新闻列表数据,不需要查询content -->
	<select id="selectNews2" parameterType="map" resultMap="news2ResultMap">
		select
		news_data.id,news_title,news_context,channel_name as
		categoryName,news_tag.tagName,news_memo,news_image,key_word,news_type,created_date,modified_date,news_url,news_data.created_by,news_channel_id
		from news_data
		left outer join news_channel on
		news_data.news_channel_id = news_channel.id
		left outer join news_tag on
		news_data.news_tag_id = news_tag.tagId
		<where>
			<if test="title!=null and title!=''">
				and news_title like concat('%',#{title},'%')
			</if>
		</where>
		<if test="start!=null and rows!=null ">
			order by created_date desc limit #{start},#{rows}
		</if>
	</select>
	<!-- 管理校友会后台新闻列表数据,不需要查询content -->
	<select id="selectNewsForAlumni" parameterType="map" resultMap="news2ResultMap">
		select
		news_data.id,news_title,news_context,channel_name as
		categoryName,news_tag.tagName,news_memo,news_image,key_word,news_type,created_date,modified_date,news_url,news_data.created_by,news_channel_id
		from news_data
		left outer join news_channel on
		news_data.news_channel_id = news_channel.id
		left outer join news_tag on
		news_data.news_tag_id = news_tag.tagId
		<where>
			<if test="title!=null and title!=''">
				and news_title like concat('%',#{title},'%')
			</if>
			<if test="deptList!=null and deptList!='' ">
				and news_tag.department_id in
				<foreach collection="deptList" open="(" close=")" item="dept"
					separator=",">
					#{dept.department_id}
				</foreach>
			</if>
		</where>
		<if test="start!=null and rows!=null ">
			order by created_date desc limit #{start},#{rows}
		</if>
	</select>
	<select id="selectById" parameterType="long" resultMap="newsResultMap">
		<!-- select * from news where newsId=#{newsId} -->
		select newsId, title, content, pic, introduction, createTime,
		cyn.type, channelName, newsUrl, cyn.cityName,cyn.dept_id,d.dept_name,
		mtype.origin as origin, pmtype.origin as originP,
		wtype.origin as
		originWeb,pwtype.origin as originWebP,
		category, mtype.name AS
		categoryName,topnews, mtype.parent_id as pCategory,pmtype.`name` as
		pCategoryName,
		categoryWeb, wtype.name AS categoryWebName,topnewsWeb,
		wtype.parent_id as pCategoryWeb,pwtype.`name` as pCategoryWebName
		from
		news cyn
		LEFT OUTER JOIN mobile_news_type mtype ON cyn.category =
		mtype.id
		LEFT OUTER JOIN mobile_news_type pmtype ON mtype.parent_id =
		pmtype.id
		LEFT OUTER JOIN web_news_type wtype ON cyn.categoryWeb =
		wtype.id
		LEFT OUTER JOIN web_news_type pwtype ON wtype.parent_id =
		pwtype.id
		LEFT OUTER JOIN cy_dept_info d on cyn.dept_id = d.dept_id
		where newsId=#{newsId}
	</select>
	<select id="selectById2" parameterType="long" resultMap="news2ResultMap">
		<!-- select * from news where newsId=#{newsId} -->
		select
		news_data.id,news_data.news_tag_id as
		tagId,news_title,channel_name as
		categoryName,news_tag.tagName,news_channel_id as
		category,news_context,news_memo,news_image,key_word,news_type,created_date,modified_date,news_url,news_data.created_by
		from news_data
		left outer join news_channel on
		news_data.news_channel_id = news_channel.id
		left outer join news_tag on
		news_data.news_tag_id = news_tag.tagId
		where news_data.id=#{newsId}
	</select>
	<!-- 新闻添加 -->
	<insert id="save" parameterType="com.hxy.core.news.entity.News">
		insert into
		news(title,content,pic,createTime,introduction,type,channelName,newsUrl,category,cityName,categoryWeb)
		values(#{title},#{content},#{pic},#{createTime},#{introduction},#{type},#{channelName},#{newsUrl},#{category},#{cityName},#{categoryWeb})
	</insert>
	<!-- 新闻添加 -->
	<insert id="save2" parameterType="com.hxy.core.news.entity.News2">
		insert into
		news_data(news_title,news_context,news_image,created_date,news_memo,news_type,news_url,news_channel_id,modified_date,created_by,news_tag_id)
		values(#{title},#{content},#{pic},#{createTime},#{introduction},#{newsType},#{newsUrl},#{category},#{modifyTime},#{creator},#{tagId})
	</insert>
	<!-- 新闻添加,返回新闻对象 -->
	<insert id="insert" useGeneratedKeys="true" keyProperty="newsId"
		parameterType="com.hxy.core.news.entity.News2">
		insert into
		news_data(news_title,news_context,news_image,created_date,news_memo,news_type,news_url,news_channel_id,modified_date,created_by,news_tag_id)
		values(#{title},#{content},#{pic},#{createTime},#{introduction},#{newsType},#{newsUrl},#{category},#{modifyTime},#{creator},#{tagId})
	</insert>


	<update id="update" parameterType="com.hxy.core.news.entity.News">
		update news set
		title=#{title},content=#{content},pic=#{pic},introduction=#{introduction},type=#{type},channelName=#{channelName},
		newsUrl=#{newsUrl},category=#{category},cityName=#{cityName},categoryWeb=#{categoryWeb},createTime=#{createTime},dept_id=#{dept_id}
		where
		newsId=#{newsId}
	</update>
	<update id="update2" parameterType="com.hxy.core.news.entity.News2">
		update news_data set
		news_title=#{title},news_context=#{content},news_image=#{pic},news_memo=#{introduction},news_type=#{newsType},
		news_url=#{newsUrl},news_channel_id=#{category},created_date=#{createTime},modified_date=#{modifyTime},news_tag_id=#{tagId}
		where
		id=#{newsId}
	</update>
	<delete id="delete" parameterType="list">
		delete from news_data where id in
		<foreach collection="list" open="(" close=")" item="ids"
			separator=",">
			#{ids}
		</foreach>
	</delete>
	<select id="selectForMicro" parameterType="map" resultMap="newsResultMap">
		select * from news
		<where>
			<if test="type!=null and type!=''">
				type=#{type}
			</if>
		</where>
		order by newsId desc limit #{start},#{rows}
	</select>
	<select id="selectByIds" parameterType="list" resultMap="newsResultMap">
		select * from news where newsId in
		<foreach collection="list" open="(" close=")" item="ids"
			separator=",">
			#{ids}
		</foreach>
		order by newsId desc
	</select>

	<select id="getAllCategorys" parameterType="map" resultMap="dictResultMap">

		select * from dict where dict_type_id in
		(select dict_type_id
		from
		dict_type

		<where>
			<if test="cateNameList!=null">
				and dict_type_name in
				<foreach collection="cateNameList" open="(" close=")" item="cateName"
					separator=",">
					#{cateName}
				</foreach>
			</if>
		</where>
		)

	</select>

	<update id="setMobTypeList" parameterType="map">
		update news set
		topnews=#{controlStr}
		where
		newsId in
		<foreach collection="list" open="(" close=")" item="ids"
			separator=",">
			#{ids}
		</foreach>
	</update>
	<update id="setWebTypeList" parameterType="map">
		update news set
		topnewsWeb=#{controlStr}
		where
		newsId in
		<foreach collection="list" open="(" close=")" item="ids"
			separator=",">
			#{ids}
		</foreach>
	</update>

	<select id="listMobTopNews" parameterType="map" resultMap="news2ResultMap">

		select * from news_data

		<where>
			<if test="category==0">
				and category is not null
			</if>
			<if test="category!=0">
				and category=#{category}
			</if>
			<if test="cityName!=null and cityName!=''">
				and cityName=#{cityName}
			</if>
		</where>

	</select>

	<!-- 查询新闻列表，列表不需要显示content -->
	<select id="listMobNews" parameterType="map" resultMap="news2ResultMap">
		<!-- select newsId, title,pic,introduction,type,channelName,newsUrl,category,date_format(createTime,'%Y-%m-%d') 
			AS fDateTime,cityName from news -->
		select news.id, news_title, news_context=null, news_image, news_memo,
		date_format(created_date,'%Y-%m-%d') AS fDateTime, news.news_type,
		news_channel_id,
		news_url, mtype.name AS
		categoryName,mtype.parent_id as
		pCategory,pmtype.`name` as pCategoryName
		from news_data news
		LEFT OUTER
		JOIN
		mobile_news_type mtype ON news.news_type = mtype.id
		LEFT OUTER JOIN
		mobile_news_type pmtype ON mtype.parent_id = pmtype.id
		<where>
			<if test="butNew!=null">
				and news.id not in (#{butNew})
			</if>
			<if test="cityName!=null and cityName!=''">
				and mtype.cityName=#{cityName}
			</if>
			<if test="parent_id!=null and parent_id!=0">
				and mtype.parent_id = #{parent_id}
			</if>
		</where>
		<if test="start!=null and start>=0 and rows!=null and rows>0 ">
			order by news.id desc limit #{start},#{rows}
		</if>
	</select>

	<!-- 查询新闻的数量 -->
	<select id="listMobNewsCount" parameterType="map" resultType="int">
		select count(news.id)
		from news_data news
		LEFT OUTER JOIN
		mobile_news_type
		mtype ON news.news_type = mtype.id
		LEFT OUTER JOIN
		mobile_news_type
		pmtype ON mtype.parent_id = pmtype.id
		<where>
			<!-- <if test="category!=null and category!=0"> and category=#{category} 
				</if> <if test="topnews!=null and topnews!=''"> and topnews = #{topnews} 
				</if> <if test="cityName!=null and cityName!=''"> and cityName=#{cityName} 
				</if> <if test="topnews==null or topnews=='' "> and (topnews is null or topnews 
				= '') </if> -->
			<if test=" category!=null and category!=0">
				and news_type=#{category}
			</if>

			<if test="butNew!=null">
				and news.id not in (#{butNew})
			</if>
			<if test="parent_id!=null and parent_id!=0">
				and mtype.parent_id = #{parent_id}
			</if>
		</where>
	</select>


	<!-- 查询新闻类别并分页 -->
	<select id="selectTypeList" parameterType="map"
		resultType="com.hxy.core.news.entity.NewsType">
		select * from mobile_news_type
		<where>
			<if test="parent_id!=null">
				and parent_id = #{parent_id}
			</if>
			<if test="type!=null and type!=0">
				and type = #{type}
			</if>
			<if test="origin!=null and origin!=0">
				and origin = #{origin}
			</if>
			<if test="origin!=null and origin==2 and alumniId!=null">
				and cityName = (select region from alumni where alumniId
				= #{alumniId})
			</if>
		</where>
		order by orderNum
		<if test="start!=null and rows!=null">
			limit #{start},#{rows}
		</if>
	</select>
	<!-- 查询新闻类别并分页 -->
	<select id="selectTypeList2" parameterType="map"
		resultType="com.hxy.core.news.entity.NewsChannel">
		select * from news_channel
		<where>
			<if test="parent_id!=null">
				and channel_pid = #{parent_id}
			</if>
			<if test="type!=null and type!=0">
				and channel_type = #{type}
			</if>
		</where>
		<if test="start!=null and rows!=null">
			limit #{start},#{rows}
		</if>
	</select>
	<!-- 查询新闻类别并分页 -->
	<select id="selectChannelbyId" parameterType="long"
		resultType="com.hxy.core.news.entity.NewsChannel">
		select * from news_channel where id =#{id}
	</select>
	<select id="selectWebTypeList" parameterType="map"
		resultType="com.hxy.core.news.entity.NewsType">
		select * from web_news_type
		<where>
			<if test="parent_id!=null">
				and parent_id = #{parent_id}
			</if>
			<if test="type!=null and type!=0">
				and type = #{type}
			</if>
			<if test="origin!=null and origin!=0">
				and origin = #{origin}
			</if>
			<if test="origin!=null and origin==2 and alumniId!=null">
				and cityName = (select region from alumni where alumniId
				= #{alumniId})
			</if>
		</where>
		order by orderNum
		<if test="start!=null and rows!=null">
			limit #{start},#{rows}
		</if>
	</select>

	<select id="selectWebNewFromWebType" parameterType="com.hxy.core.news.entity.NewsType"
		resultType="com.hxy.core.news.entity.News">
		SELECT * from news ta
		INNER JOIN mobile_news_type tb
		ON
		ta.category=tb.id
		<where>

			AND ta.category=#{id}

		</where>
		limit 0,1

	</select>

</mapper>